<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOVA WHOWHERE </title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: url('https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQIL2CHZpyTiwnpclh-sCg2zDYcM_mXKT6tpw&usqp=CAU') no-repeat center center fixed;
            background-size: cover;
            color: white;
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            overflow-y: scroll;
            width: 100%;
            height: 100vh;
        }
        .header, .user-list {
            width: 100%;
            text-align: center;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .user {
            margin: 5px;
            border: 1px solid #ccc;
            border-radius: 3px;
            text-align: center;
            padding: 5px;
            background-color: rgba(255, 255, 255, 0.8);
        }
        #userSearch {
            padding: 10px;
            width: 80%;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <input type="text" id="userSearch" placeholder="Kullanıcıları ara 🔍">
            <div style="margin-top: 10px;">
                <label for="profileOnly" style="color: white;">Sadece profili olan Kullanıcıları listele</label>
                <input type="checkbox" id="profileOnly" style="margin-left: 10px;">
            </div>
        </div>
        <div id="userList" class="user-list">
            <div><h1>Kullanıcıları Listeleniyor...</h1></div>
        </div>
    </div>
    <script>
        if (window.location.href.indexOf("?novaww2") != -1) {
            window.location.href.indexOf("&lang=") != -1 ? window.lang = window.location.href.split("&lang=")[1] : window.lang = 8;

            function updateUsers() {
                let userList = document.getElementById("userList");
                userList.innerHTML = "<div><h3>Kullanıcı Listesi</h3></div>"
                window.players.forEach(user => {
                    let userElement = document.createElement("div");
                    userElement.className = "user";
                    userElement.innerHTML = `
                        <img title="${user.id}" width="50" src="${user.foto ? user.foto : 'https://gartic.io/static/images/avatar/svg/' + user.avatar + '.svg'}"><br>
                        <b>${user.nick}</b> <span>${user.points}p</span><br>
                        <a target="_blank" style="color:grey;" href="${user.room}">${user.room.slice(8)}</a><br>
                        <a target="_blank" style="color:grey;" href="${user.room}/viewer"><b>Viewer</b></a>
                    `;
                    userElement.dataset.hasProfile = user.foto ? "true" : "false";
                    userList.appendChild(userElement);
                })
                filterUsers();
            }

            function filterUsers() {
                let filter = document.getElementById("userSearch").value.toLowerCase();
                let profileOnly = document.getElementById("profileOnly").checked;
                let users = document.querySelectorAll(".user");
                users.forEach(user => {
                    let userName = user.querySelector("b").textContent.toLowerCase();
                    let hasProfile = user.dataset.hasProfile === "true";
                    if (userName.indexOf(filter) > -1 && (!profileOnly || hasProfile)) {
                        user.style.display = "";
                    } else {
                        user.style.display = "none";
                    }
                });
            }

            window.players = [];
            function getData(roomCode) {
                let servers = ["server01", "server02", "server03", "server04", "server05", "server06"];
                servers.forEach(server => {
                    let ws = new WebSocket(`wss://${server}.gartic.io/socket.io/?EIO=3&transport=websocket`);
                    ws.onopen = () => {
                        ws.send('42[12,{"v":20000,"platform":0,"sala":"' + roomCode.slice(-4) + '"}]');
                    }
                    ws.onmessage = (msg) => {
                        if (msg.data[4] == "5") {
                            let data = JSON.parse(msg.data.slice(2));
                            if (data[0] == 5) {
                                data[5].forEach(user => {
                                    window.players.push({
                                        "points": user.pontos,
                                        "victory": user.vitorias,
                                        "id": user.id,
                                        "avatar": user.avatar,
                                        "room": "https://gartic.io/" + roomCode,
                                        "nick": user.nick,
                                        "foto": user.foto
                                    });
                                });
                                updateUsers();
                                ws.close();
                            }
                        }
                    }
                });
            }

            fetch(`https://gartic.io/req/list?search=&language[]=${window.lang}`).then(x => x.json()).then(x => {
                x.forEach(room => {
                    if (room.quant > 0) {
                        getData(room.code);
                    }
                });
            })

            document.getElementById("userSearch").addEventListener("input", filterUsers);
            document.getElementById("profileOnly").addEventListener("change", filterUsers);
        }
    </script>
</body>
</html>
